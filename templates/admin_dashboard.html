{% extends "base.html" %}

{% block title %}× ×™×”×•×œ{% endblock %}

{% block content %}
<div class="nav">
    <a href="{{ url_for('index') }}">&lt; ×“×£ ×”×‘×™×ª</a> |
    <a href="{{ url_for('admin_logout') }}">×”×ª× ×ª×§</a>
</div>

<h1>× ×™×”×•×œ ×©×™×¨×™×</h1>

<a href="{{ url_for('admin_add_song') }}" class="button">+ ×”×•×¡×£ ×©×™×¨ ×—×“×©</a>

<!-- Active Download Jobs -->
{% if jobs %}
<div style="background: #e8f4ff; border: 2px solid #4a90e2; border-radius: 5px; padding: 15px; margin: 20px 0;">
    <h3 style="margin: 0 0 10px 0;">×”×•×¨×“×•×ª ×¤×¢×™×œ×•×ª</h3>
    {% for job in jobs %}
    <div id="job_{{ job.id }}" style="padding: 10px; background: white; border-radius: 3px; margin-bottom: 10px;">
        <strong>{{ job.song_name }}</strong><br>
        <span class="job-status" data-job-id="{{ job.id }}" data-status="{{ job.status }}">
            {% if job.status == 'pending' %}
            â³ {{ job.message }}
            {% elif job.status == 'downloading' %}
            â¬‡ï¸ {{ job.message }}
            {% elif job.status == 'completed' %}
            âœ… {{ job.message }}
            {% elif job.status == 'failed' %}
            âŒ {{ job.message }}
            {% endif %}
        </span>
    </div>
    {% endfor %}
</div>

<script>
// Poll for job status updates
var activeJobs = [{% for job in jobs %}'{{ job.id }}'{% if not loop.last %}, {% endif %}{% endfor %}];
var pollInterval = null;
var completedJobs = 0;

function checkJobStatus() {
    var jobsToCheck = activeJobs.filter(function(jobId) {
        var statusEl = document.querySelector('[data-job-id="' + jobId + '"]');
        return statusEl && statusEl.dataset.status !== 'completed' && statusEl.dataset.status !== 'failed';
    });

    if (jobsToCheck.length === 0) {
        if (pollInterval) {
            clearInterval(pollInterval);
            pollInterval = null;
        }
        // Reload page if any jobs completed
        if (completedJobs > 0) {
            window.location.reload();
        }
        return;
    }

    jobsToCheck.forEach(function(jobId) {
        fetch('/admin/job-status/' + jobId)
            .then(function(response) { return response.json(); })
            .then(function(data) {
                var statusEl = document.querySelector('[data-job-id="' + jobId + '"]');
                if (statusEl) {
                    var icon = 'â³';
                    if (data.status === 'downloading') icon = 'â¬‡ï¸';
                    else if (data.status === 'completed') {
                        icon = 'âœ…';
                        completedJobs++;
                    }
                    else if (data.status === 'failed') icon = 'âŒ';

                    statusEl.innerHTML = icon + ' ' + data.message;
                    statusEl.dataset.status = data.status;

                    // If completed or failed, stop checking after a delay
                    if (data.status === 'completed' || data.status === 'failed') {
                        setTimeout(function() {
                            checkJobStatus();
                        }, 2000);
                    }
                }
            })
            .catch(function(error) {
                console.error('Error checking job status:', error);
            });
    });
}

// Start polling every 2 seconds
if (activeJobs.length > 0) {
    pollInterval = setInterval(checkJobStatus, 2000);
    // Also check immediately
    checkJobStatus();
}
</script>
{% endif %}

<h2>×©×™×¨×™×</h2>

{% if songs %}
    {% for song in songs %}
    <div class="song-item">
        <table width="100%" cellpadding="5" cellspacing="0" border="0">
            <tr>
                <td width="90" valign="top">
                    {% if song.thumbnail %}
                    <img src="{{ url_for('static', filename='thumbnails/' + song.thumbnail) }}" alt="{{ song.display_name }}" width="80" height="60" style="border-radius: 5px;">
                    {% else %}
                    <div style="width: 80px; height: 60px; background: #f0f0f0; text-align: center; line-height: 60px; font-size: 30px; border-radius: 5px;">ğŸµ</div>
                    {% endif %}
                </td>
                <td valign="top">
                    <strong>{{ song.display_name }}</strong>
                    <br><br>
                    <a href="{{ url_for('admin_edit_song', song_id=loop.index0) }}" class="button">×¢×¨×•×š</a>
                    <form method="POST" action="{{ url_for('admin_delete_song', song_id=loop.index0) }}" style="display:inline;">
                        <button type="submit" class="button button-danger" onclick="return confirm('×œ××—×•×§ ××ª ×”×©×™×¨?')">××—×§</button>
                    </form>
                </td>
            </tr>
        </table>
    </div>
    {% endfor %}
{% else %}
    <p>××™×Ÿ ×©×™×¨×™× ×¢×“×™×™×Ÿ.</p>
{% endif %}
{% endblock %}
