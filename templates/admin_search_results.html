{% extends "base.html" %}

{% block title %}×ª×•×¦××•×ª ×—×™×¤×•×©{% endblock %}

{% block content %}
<div class="nav">
    <a href="{{ url_for('admin_add_song') }}">&lt; ×—×–×¨×” ×œ×—×™×¤×•×©</a> |
    <a href="{{ url_for('admin_dashboard') }}">×œ×•×— ×”×‘×§×¨×”</a>
</div>

<h1>×ª×•×¦××•×ª ×—×™×¤×•×©: {{ song_name }} - {{ artist_name }}</h1>

{% if error %}
<div class="error">{{ error }}</div>
{% endif %}

<!-- Debug Test Button -->
<div style="background: #fff3cd; border: 1px solid #ffc107; padding: 10px; margin: 10px 0; border-radius: 5px;">
    <strong>ğŸ”§ Debug Test:</strong>
    <button onclick="testPing()" style="margin-right: 10px; padding: 5px 15px;">Test Server Connection</button>
    <span id="pingResult"></span>
</div>

<p>×‘×—×¨ ××ª ×”×¡×¨×˜×•×Ÿ ×”××ª××™×:</p>

<form method="POST" action="{{ url_for('admin_download_song') }}">
    <input type="hidden" name="song_name" value="{{ song_name }}">
    <input type="hidden" name="artist_name" value="{{ artist_name }}">

    {% for video in results %}
    <div class="search-result" id="result_{{ loop.index0 }}">
        <input type="radio" name="selected_video" id="video_{{ loop.index0 }}"
               value="{{ video.url }}"
               data-title="{{ video.title }}"
               data-thumbnail="{{ video.thumbnail }}"
               required>
        <label for="video_{{ loop.index0 }}" style="display: block; margin-bottom: 5px;">
            <strong>{{ video.title }}</strong>
            <br>
            <small>×¢×¨×•×¥: {{ video.channel }}</small>
            {% if video.duration %}
            | <small>××©×š: {{ (video.duration // 60) }}:{{ '%02d' % (video.duration % 60) }}</small>
            {% endif %}
        </label>

        <iframe width="100%" height="200"
                src="https://www.youtube.com/embed/{{ video.id }}"
                frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen
                style="max-width: 100%; border-radius: 5px; margin-bottom: 10px;">
        </iframe>
    </div>
    {% endfor %}

    <br>
    <button type="submit" class="button" id="downloadButton" onclick="return prepareDownload()">×”×•×¨×“ ××ª ×”×©×™×¨ ×”× ×‘×—×¨</button>
</form>

<!-- Loading Overlay -->
<div id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; text-align: center;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); max-width: 400px;">
        <h2 style="margin: 0 0 10px 0; color: #333;">â³ ××•×¨×™×“ ××™×•×˜×™×•×‘...</h2>
        <p style="margin: 0; color: #666;">× × ×œ×”××ª×™×Ÿ, ×–×” ×¢×©×•×™ ×œ×§×—×ª ×›××” ×“×§×•×ª</p>
        <p style="margin: 10px 0 0 0; color: #999; font-size: 14px;">×”×•×¨×“×ª ×”×§×•×‘×¥ ×•×”××¨×” ×œ-MP3...</p>
        <div id="overlayTimer" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd;">
            <p style="margin: 0 0 10px 0; color: #e67e22; font-size: 14px;">×”×”×•×¨×“×” ×œ×•×§×—×ª ×™×•×ª×¨ ×–××Ÿ ××”×¦×¤×•×™...</p>
            <button onclick="dismissOverlay()" style="padding: 10px 20px; background: #e74c3c; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">âœ• ×¡×’×•×¨ ×•×‘×“×•×§ ×××•×—×¨ ×™×•×ª×¨</button>
            <p style="margin: 10px 0 0 0; color: #999; font-size: 12px;">×”×©×™×¨ ×¢×“×™×™×Ÿ ××ª×¢×‘×“ ×‘×¨×§×¢</p>
        </div>
    </div>
</div>

<script>
var downloadTimer = null;

// Hide overlay on page load (in case of error/page reload)
window.onload = function() {
    var overlay = document.getElementById('loadingOverlay');
    if (overlay) {
        overlay.style.display = 'none';
    }
    // Clear timer if exists
    if (downloadTimer) {
        clearTimeout(downloadTimer);
        downloadTimer = null;
    }
};

// Test server connectivity
function testPing() {
    console.log('[TEST] Sending POST to /admin/ping');
    document.getElementById('pingResult').textContent = 'â³ Testing...';

    fetch('/admin/ping', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: 'test=1'
    })
    .then(response => {
        console.log('[TEST] Response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('[TEST] Response data:', data);
        document.getElementById('pingResult').textContent = 'âœ… Server reachable! Status: ' + data.status;
        document.getElementById('pingResult').style.color = 'green';
    })
    .catch(error => {
        console.error('[TEST] Error:', error);
        document.getElementById('pingResult').textContent = 'âŒ Failed: ' + error.message;
        document.getElementById('pingResult').style.color = 'red';
    });
}

function dismissOverlay() {
    document.getElementById('loadingOverlay').style.display = 'none';
    if (downloadTimer) {
        clearTimeout(downloadTimer);
        downloadTimer = null;
    }
    alert('×”×”×•×¨×“×” ×¢×“×™×™×Ÿ ××ª×‘×¦×¢×ª ×‘×¨×§×¢. ×× ×”×©×™×¨ ×œ× ××•×¤×™×¢ ×ª×•×š ×“×§×•×ª ××—×“×•×ª, × ×¡×” ×©×•×‘.');
}

function prepareDownload() {
    console.log('[CLIENT] prepareDownload() START');

    var selected = document.querySelector('input[name="selected_video"]:checked');
    if (!selected) {
        console.log('[CLIENT] No video selected');
        alert('× × ×œ×‘×—×•×¨ ×¡×¨×˜×•×Ÿ');
        return false;
    }

    console.log('[CLIENT] Selected URL:', selected.value);
    console.log('[CLIENT] Selected title:', selected.dataset.title);

    // Add hidden fields with video data
    var form = selected.closest('form');
    console.log('[CLIENT] Form found:', form);
    console.log('[CLIENT] Form action:', form.action);
    console.log('[CLIENT] Form method:', form.method);
    console.log('[CLIENT] Form elements:', form.elements.length);

    var urlInput = document.createElement('input');
    urlInput.type = 'hidden';
    urlInput.name = 'youtube_url';
    urlInput.value = selected.value;
    form.appendChild(urlInput);

    var titleInput = document.createElement('input');
    titleInput.type = 'hidden';
    titleInput.name = 'youtube_title';
    titleInput.value = selected.dataset.title;
    form.appendChild(titleInput);

    var thumbInput = document.createElement('input');
    thumbInput.type = 'hidden';
    thumbInput.name = 'youtube_thumbnail';
    thumbInput.value = selected.dataset.thumbnail;
    form.appendChild(thumbInput);

    console.log('[CLIENT] Hidden fields added to form');

    // Show loading overlay
    document.getElementById('loadingOverlay').style.display = 'block';
    var btn = document.getElementById('downloadButton');
    btn.disabled = true;

    console.log('[CLIENT] Overlay shown, button disabled');

    // After 30 seconds, show close button
    downloadTimer = setTimeout(function() {
        console.log('[CLIENT] 30 seconds elapsed');
        var timer = document.getElementById('overlayTimer');
        if (timer) {
            timer.style.display = 'block';
        }
    }, 30000); // 30 seconds

    console.log('[CLIENT] About to submit form...');
    console.log('[CLIENT] Triggering form.submit() manually');

    // Submit the form programmatically
    setTimeout(function() {
        console.log('[CLIENT] Calling form.submit() NOW');
        form.submit();
        console.log('[CLIENT] form.submit() called successfully');
    }, 100);

    // Prevent default form submission since we're doing it manually
    console.log('[CLIENT] Returning false to prevent default, will submit programmatically');
    return false;
}
</script>

<style>
.search-result {
    border: 2px solid #ddd;
    margin: 15px 0;
    padding: 15px;
    border-radius: 5px;
    background: #fff;
}

.search-result input[type="radio"]:checked ~ label {
    background-color: #e8f4ff;
    padding: 5px;
    border-radius: 3px;
}

label {
    cursor: pointer;
    padding: 5px;
}

small {
    color: #666;
}
</style>
{% endblock %}
