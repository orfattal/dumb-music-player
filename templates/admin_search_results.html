{% extends "base.html" %}

{% block title %}תוצאות חיפוש{% endblock %}

{% block content %}
<div class="nav">
    <a href="{{ url_for('admin_add_song') }}">&lt; חזרה לחיפוש</a> |
    <a href="{{ url_for('admin_dashboard') }}">לוח הבקרה</a>
</div>

<h1>תוצאות חיפוש: {{ song_name }} - {{ artist_name }}</h1>

{% if error %}
<div class="error">{{ error }}</div>
{% endif %}

<p>בחר את הסרטון המתאים:</p>

<form method="POST" action="{{ url_for('admin_download_song') }}">
    <input type="hidden" name="song_name" value="{{ song_name }}">
    <input type="hidden" name="artist_name" value="{{ artist_name }}">

    {% for video in results %}
    <div class="search-result" id="result_{{ loop.index0 }}">
        <input type="radio" name="selected_video" id="video_{{ loop.index0 }}"
               value="{{ video.url }}"
               data-title="{{ video.title }}"
               data-thumbnail="{{ video.thumbnail }}"
               required
               onclick="showPlayer('{{ video.id }}', {{ loop.index0 }})">
        <label for="video_{{ loop.index0 }}">
            <table width="100%" cellpadding="5" cellspacing="0" border="0">
                <tr>
                    <td width="130" valign="top">
                        <img src="{{ video.thumbnail }}" alt="{{ video.title }}" width="120" height="90" style="border-radius: 5px;">
                    </td>
                    <td valign="top">
                        <strong>{{ video.title }}</strong>
                        <br>
                        <small>ערוץ: {{ video.channel }}</small>
                        <br>
                        {% if video.duration %}
                        <small>משך: {{ (video.duration // 60) }}:{{ '%02d' % (video.duration % 60) }}</small>
                        {% endif %}
                    </td>
                </tr>
            </table>
        </label>
        <div id="player_{{ loop.index0 }}" style="display: none; margin-top: 10px;">
            <iframe width="100%" height="200"
                    src="https://www.youtube.com/embed/{{ video.id }}"
                    frameborder="0"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                    allowfullscreen
                    style="max-width: 100%; border-radius: 5px;">
            </iframe>
        </div>
    </div>
    {% endfor %}

    <br>
    <button type="submit" class="button" onclick="return prepareDownload()">הורד את השיר הנבחר</button>
</form>

<script>
var currentPlayer = null;

function showPlayer(videoId, index) {
    // Hide previous player
    if (currentPlayer !== null) {
        var prevPlayer = document.getElementById('player_' + currentPlayer);
        if (prevPlayer) {
            prevPlayer.style.display = 'none';
        }
    }

    // Show current player
    var player = document.getElementById('player_' + index);
    if (player) {
        player.style.display = 'block';
        currentPlayer = index;
    }
}

function prepareDownload() {
    var selected = document.querySelector('input[name="selected_video"]:checked');
    if (!selected) {
        alert('נא לבחור סרטון');
        return false;
    }

    // Add hidden fields with video data
    var form = selected.closest('form');

    var urlInput = document.createElement('input');
    urlInput.type = 'hidden';
    urlInput.name = 'youtube_url';
    urlInput.value = selected.value;
    form.appendChild(urlInput);

    var titleInput = document.createElement('input');
    titleInput.type = 'hidden';
    titleInput.name = 'youtube_title';
    titleInput.value = selected.dataset.title;
    form.appendChild(titleInput);

    var thumbInput = document.createElement('input');
    thumbInput.type = 'hidden';
    thumbInput.name = 'youtube_thumbnail';
    thumbInput.value = selected.dataset.thumbnail;
    form.appendChild(thumbInput);

    return true;
}
</script>

<style>
.search-result {
    border: 2px solid #ddd;
    margin: 15px 0;
    padding: 10px;
    border-radius: 5px;
    background: #fff;
}

.search-result input[type="radio"]:checked + label {
    background-color: #e8f4ff;
}

label {
    cursor: pointer;
    display: block;
    padding: 5px;
}

small {
    color: #666;
}
</style>
{% endblock %}
